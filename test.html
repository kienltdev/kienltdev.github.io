<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Nhiệm vụ Học tập</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .task-container {
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
            border-radius: 8px;
            margin-bottom: 10px;
            position: relative;
        }

        .high-priority {
            border-left: 4px solid #e74c3c;
        }

        .medium-priority {
            border-left: 4px solid #f39c12;
        }

        .low-priority {
            border-left: 4px solid #3498db;
        }

        .tab {
            cursor: pointer;
            padding: 12px 16px;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            border-radius: 25px;
            transition: all 0.3s;
        }

        .tab.active {
            background-color: #e3f2fd;
            color: #1976d2;
            font-weight: 600;
        }

        .not-started-badge {
            background-color: #e0d6ff;
            color: #7c4dff;
        }

        .in-progress-badge {
            background-color: #cce5ff;
            color: #007bff;
        }

        .completed-badge {
            background-color: #d4edda;
            color: #28a745;
        }

        .custom-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #ddd;
            border-radius: 50%;
            position: relative;
            cursor: pointer;
        }

        .custom-checkbox.checked {
            background-color: #4caf50;
            border-color: #4caf50;
        }

        .custom-checkbox.checked::after {
            content: "\2713";
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
        }

        .dropdown-menu {
            position: absolute;
            right: 10px;
            top: 40px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            min-width: 160px;
        }

        .dropdown-item {
            padding: 10px 16px;
            cursor: pointer;
            font-size: 14px;
        }

        .dropdown-item:hover {
            background-color: #f1f1f1;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1050;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .notification {
            position: fixed;
            top: -100px;
            left: 0;
            right: 0;
            width: 90%;
            max-width: 400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            padding: 12px 16px;
            transition: top 0.3s ease-in-out;
            display: flex;
            align-items: center;
        }

        .notification.show {
            top: 20px;
        }

        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .notification-content {
            flex-grow: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 2px;
            font-size: 14px;
        }

        .notification-body {
            font-size: 13px;
            color: #555;
        }

        .notification-close {
            padding: 8px;
            cursor: pointer;
            color: #aaa;
            font-size: 18px;
        }

        .notification-overdue .notification-icon {
            background-color: #ffebee;
            color: #e53935;
        }

        .notification-upcoming .notification-icon {
            background-color: #e8f5e9;
            color: #43a047;
        }

        .notification-incomplete .notification-icon {
            background-color: #fff8e1;
            color: #ffa000;
        }

        .notification-motivational .notification-icon {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        @media screen and (max-width: 640px) {
            .tab {
                padding: 8px 12px;
                font-size: 13px;
            }
        }
    </style>
</head>

<body class="bg-gray-100">
    <div class="max-w-md mx-auto bg-white min-h-screen shadow-lg">
        <!-- Header -->
        <header class="px-4 py-4 flex items-center justify-between border-b border-gray-200">
            <h1 class="text-xl font-bold">Nhiệm vụ của tôi</h1>
            <div class="flex items-center space-x-2">
                <button id="notificationBtn"
                    class="w-10 h-10 rounded-full flex items-center justify-center hover:bg-gray-100">
                    <i class="fas fa-bell text-gray-600"></i>
                </button>
                <button id="addTaskBtn"
                    class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white shadow-md hover:bg-blue-600">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </header>

        <!-- Description -->
        <div class="px-4 py-2 text-gray-500 text-sm">
            Quản lý các nhiệm vụ học tập của bạn
        </div>

        <!-- Progress -->
        <div class="m-4 p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
            <div class="flex justify-between items-center mb-2">
                <span class="text-gray-700 font-medium">Tiến độ tổng thể</span>
                <span id="progressPercentage" class="text-gray-700 font-medium">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div id="progressBar" class="bg-green-500 h-2.5 rounded-full" style="width: 0%"></div>
            </div>
            <div class="flex justify-between mt-3 text-sm">
                <span id="completedCount" class="text-green-600"><i class="fas fa-check-circle mr-1"></i> 0 đã hoàn thành</span>
                <span id="overdueCount" class="text-red-500"><i class="fas fa-exclamation-circle mr-1"></i> 0 quá hạn</span>
            </div>
        </div>

        <!-- Tabs -->
        <div class="mx-4 mb-3 bg-gray-100 rounded-lg p-1 flex justify-between">
            <div id="allTab" class="tab active" data-tab="all">Tất cả (0)</div>
            <div id="notStartedTab" class="tab" data-tab="notStarted">Chưa làm (0)</div>
            <div id="inProgressTab" class="tab" data-tab="inProgress">Đang làm (0)</div>
            <div id="completedTab" class="tab" data-tab="completed">Đã làm (0)</div>
        </div>

        <!-- Task List -->
        <div id="taskContainer" class="px-4 py-2">
            <div id="emptyMessage" class="text-center py-10 text-gray-500">
                <i class="fas fa-tasks mb-3 text-3xl"></i>
                <p>Không có nhiệm vụ nào. Nhấn + để thêm mới.</p>
            </div>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div id="addTaskModal" class="modal">
        <div class="modal-content p-5">
            <div class="flex justify-between items-center mb-5">
                <h2 class="text-xl font-bold">Thêm nhiệm vụ mới</h2>
                <button class="closeModal text-gray-500 hover:text-gray-700 text-xl">&times;</button>
            </div>

            <form id="addTaskForm">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2" for="taskTitle">
                        Tiêu đề nhiệm vụ<span class="text-red-500">*</span>
                    </label>
                    <input class="w-full px-3 py-2 border border-gray-300 rounded-md" id="taskTitle" type="text"
                        required>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2" for="taskSubject">
                        Môn học<span class="text-red-500">*</span>
                    </label>
                    <input class="w-full px-3 py-2 border border-gray-300 rounded-md" id="taskSubject" type="text"
                        required list="subjectList">
                    <datalist id="subjectList"></datalist>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2" for="taskDeadlineDate">
                        Deadline<span class="text-red-500">*</span>
                    </label>
                    <div class="flex space-x-2">
                        <input class="w-2/3 px-3 py-2 border border-gray-300 rounded-md" id="taskDeadlineDate"
                            type="date" required>
                        <input class="w-1/3 px-3 py-2 border border-gray-300 rounded-md" id="taskDeadlineTime"
                            type="time" required>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2" for="taskPriority">
                        Mức độ ưu tiên<span class="text-red-500">*</span>
                    </label>
                    <select class="w-full px-3 py-2 border border-gray-300 rounded-md" id="taskPriority" required>
                        <option value="high">Cao</option>
                        <option value="medium">Trung bình</option>
                        <option value="low">Thấp</option>
                    </select>
                </div>

                <div class="mb-5">
                    <label class="block text-gray-700 text-sm font-medium mb-2" for="taskStatus">
                        Trạng thái<span class="text-red-500">*</span>
                    </label>
                    <select class="w-full px-3 py-2 border border-gray-300 rounded-md" id="taskStatus" required>
                        <option value="notStarted">Chưa làm</option>
                        <option value="inProgress">Đang làm</option>
                        <option value="completed">Đã làm</option>
                    </select>
                </div>

                <div class="flex justify-end space-x-2">
                    <button type="button"
                        class="closeModal px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">Hủy</button>
                    <button type="submit"
                        class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">Thêm</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div id="editTaskModal" class="modal">
        <div class="modal-content p-5">
            <div class="flex justify-between items-center mb-5">
                <h2 class="text-xl font-bold">Chỉnh sửa nhiệm vụ</h2>
                <button class="closeModal text-gray-500 hover:text-gray-700 text-xl">&times;</button>
            </div>

            <form id="editTaskForm">
                <input type="hidden" id="editTaskId">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2" for="editTaskTitle">
                        Tiêu đề nhiệm vụ<span class="text-red-500">*</span>
                    </label>
                    <input class="w-full px-3 py-2 border border-gray-300 rounded-md" id="editTaskTitle" type="text"
                        required>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2" for="editTaskSubject">
                        Môn học<span class="text-red-500">*</span>
                    </label>
                    <input class="w-full px-3 py-2 border border-gray-300 rounded-md" id="editTaskSubject" type="text"
                        required list="subjectList">
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2" for="editTaskDeadlineDate">
                        Deadline<span class="text-red-500">*</span>
                    </label>
                    <div class="flex space-x-2">
                        <input class="w-2/3 px-3 py-2 border border-gray-300 rounded-md" id="editTaskDeadlineDate"
                            type="date" required>
                        <input class="w-1/3 px-3 py-2 border border-gray-300 rounded-md" id="editTaskDeadlineTime"
                            type="time" required>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2" for="editTaskPriority">
                        Mức độ ưu tiên<span class="text-red-500">*</span>
                    </label>
                    <select class="w-full px-3 py-2 border border-gray-300 rounded-md" id="editTaskPriority" required>
                        <option value="high">Cao</option>
                        <option value="medium">Trung bình</option>
                        <option value="low">Thấp</option>
                    </select>
                </div>

                <div class="mb-5">
                    <label class="block text-gray-700 text-sm font-medium mb-2" for="editTaskStatus">
                        Trạng thái<span class="text-red-500">*</span>
                    </label>
                    <select class="w-full px-3 py-2 border border-gray-300 rounded-md" id="editTaskStatus" required>
                        <option value="notStarted">Chưa làm</option>
                        <option value="inProgress">Đang làm</option>
                        <option value="completed">Đã làm</option>
                    </select>
                </div>

                <div class="flex justify-end space-x-2">
                    <button type="button"
                        class="closeModal px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">Hủy</button>
                    <button type="submit"
                        class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">Lưu</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification">
        <div class="notification-icon">
            <i class="fas fa-bell"></i>
        </div>
        <div class="notification-content">
            <div class="notification-title">Thông báo</div>
            <div class="notification-body">Nội dung thông báo</div>
        </div>
        <div class="notification-close">
            <i class="fas fa-times"></i>
        </div>
    </div>

    <script>
        // Clear localStorage to ensure no old data remains
        localStorage.removeItem('tasks');
        localStorage.removeItem('subjects');

        // Main app variables
        let tasks = [];
        let subjects = [];
        let currentTab = 'all';
        let activeDropdown = null;
        let notificationInterval;
        let notificationQueue = [];
        let notificationQueueIndex = 0;

        // Elements
        const taskContainer = document.getElementById('taskContainer');
        const emptyMessage = document.getElementById('emptyMessage');
        const addTaskModal = document.getElementById('addTaskModal');
        const editTaskModal = document.getElementById('editTaskModal');
        const addTaskForm = document.getElementById('addTaskForm');
        const editTaskForm = document.getElementById('editTaskForm');
        const subjectListElement = document.getElementById('subjectList');
        const progressBar = document.getElementById('progressBar');
        const progressPercentage = document.getElementById('progressPercentage');
        const completedCount = document.getElementById('completedCount');
        const overdueCount = document.getElementById('overdueCount');
        const allTabElement = document.getElementById('allTab');
        const notStartedTabElement = document.getElementById('notStartedTab');
        const inProgressTabElement = document.getElementById('inProgressTab');
        const completedTabElement = document.getElementById('completedTab');
        const notification = document.getElementById('notification');

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            loadTasks();
            loadSubjects();
            updateSubjectList();
            renderTasks();
            setupEventListeners();
            startNotifications();
        });

        // Event listeners setup
        function setupEventListeners() {
            // Open add task modal
            document.getElementById('addTaskBtn').addEventListener('click', () => {
                openModal(addTaskModal);
            });

            // Close modals
            document.querySelectorAll('.closeModal').forEach(btn => {
                btn.addEventListener('click', () => {
                    closeAllModals();
                });
            });

            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const tabName = e.target.dataset.tab;
                    switchTab(tabName);
                });
            });

            // Add task form submission
            addTaskForm.addEventListener('submit', (e) => {
                e.preventDefault();
                addTask();
            });

            // Edit task form submission
            editTaskForm.addEventListener('submit', (e) => {
                e.preventDefault();
                saveEditedTask();
            });

            // Close notification
            document.querySelector('.notification-close').addEventListener('click', () => {
                hideNotification();
            });

            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.task-actions') && activeDropdown) {
                    closeDropdown(activeDropdown);
                }
            });
        }

        // Task Management Functions
        function addTask() {
            const title = document.getElementById('taskTitle').value.trim();
            const subject = document.getElementById('taskSubject').value.trim();
            const deadlineDate = document.getElementById('taskDeadlineDate').value;
            const deadlineTime = document.getElementById('taskDeadlineTime').value;
            const priority = document.getElementById('taskPriority').value;
            const status = document.getElementById('taskStatus').value;

            // Check for duplicate tasks
            if (isDuplicateTask(title, subject)) {
                showAlert('Nhiệm vụ này đã tồn tại!');
                return;
            }

            // Create new task object
            const newTask = {
                id: generateUniqueId(),
                title,
                subject,
                deadline: `${deadlineDate}T${deadlineTime}`,
                priority,
                status,
                createdAt: new Date().toISOString()
            };

            // Add to tasks array
            tasks.push(newTask);

            // Add subject to list if new
            if (!subjects.includes(subject)) {
                subjects.push(subject);
                saveSubjects();
                updateSubjectList();
            }

            // Save, render, and close modal
            saveTasks();
            renderTasks();
            closeAllModals();
            resetAddTaskForm();
            resetNotificationQueue(); // Thêm dòng này

            // Show confirmation
            showNotification('Thêm nhiệm vụ thành công', `Nhiệm vụ "${title}" đã được thêm vào.`, 'success');
        }

        function deleteTask(taskId) {
            const index = tasks.findIndex(task => task.id === taskId);
            if (index !== -1) {
                const deletedTask = tasks[index];
                tasks.splice(index, 1);
                saveTasks();
                renderTasks();
                resetNotificationQueue(); // Thêm dòng này
                showNotification('Xóa nhiệm vụ thành công', `Nhiệm vụ "${deletedTask.title}" đã được xóa.`, 'info');
            }
        }

        function changeTaskStatus(taskId, newStatus) {
            const task = tasks.find(task => task.id === taskId);
            if (task) {
                task.status = newStatus;
                saveTasks();
                renderTasks();
                resetNotificationQueue(); // Thêm dòng này
                showNotification('Cập nhật trạng thái', `Nhiệm vụ "${task.title}" đã chuyển sang ${translateStatus(newStatus)}.`, 'info');
            }
        }

        function editTask(taskId) {
            const task = tasks.find(task => task.id === taskId);
            if (!task) return;

            // Fill form with task data
            document.getElementById('editTaskId').value = task.id;
            document.getElementById('editTaskTitle').value = task.title;
            document.getElementById('editTaskSubject').value = task.subject;

            const deadlineDateTime = new Date(task.deadline);
            const deadlineDate = deadlineDateTime.toISOString().split('T')[0];
            let deadlineTime = deadlineDateTime.toTimeString().slice(0, 5);

            document.getElementById('editTaskDeadlineDate').value = deadlineDate;
            document.getElementById('editTaskDeadlineTime').value = deadlineTime;
            document.getElementById('editTaskPriority').value = task.priority;
            document.getElementById('editTaskStatus').value = task.status;

            openModal(editTaskModal);
        }

        function saveEditedTask() {
            const taskId = document.getElementById('editTaskId').value;
            const newTitle = document.getElementById('editTaskTitle').value.trim();
            const newSubject = document.getElementById('editTaskSubject').value.trim();
            const newDeadlineDate = document.getElementById('editTaskDeadlineDate').value;
            const newDeadlineTime = document.getElementById('editTaskDeadlineTime').value;
            const newPriority = document.getElementById('editTaskPriority').value;
            const newStatus = document.getElementById('editTaskStatus').value;

            const task = tasks.find(task => task.id === taskId);
            if (!task) return;

            // Check if edited task would create a duplicate
            if (newTitle !== task.title || newSubject !== task.subject) {
                if (isDuplicateTask(newTitle, newSubject, taskId)) {
                    showAlert('Nhiệm vụ này đã tồn tại!');
                    return;
                }
            }

            // Update task
            task.title = newTitle;
            task.subject = newSubject;
            task.deadline = `${newDeadlineDate}T${newDeadlineTime}`;
            task.priority = newPriority;
            task.status = newStatus;

            // Add subject to list if new
            if (!subjects.includes(newSubject)) {
                subjects.push(newSubject);
                saveSubjects();
                updateSubjectList();
            }

            // Save and render
            saveTasks();
            renderTasks();
            closeAllModals();
            resetNotificationQueue(); // Thêm dòng này

            // Show confirmation
            showNotification('Cập nhật thành công', `Nhiệm vụ "${newTitle}" đã được cập nhật.`, 'success');
        }

        // UI Functions
        function renderTasks() {
            // Filter tasks based on current tab
            let filteredTasks = [];
            switch (currentTab) {
                case 'notStarted':
                    filteredTasks = tasks.filter(task => task.status === 'notStarted');
                    break;
                case 'inProgress':
                    filteredTasks = tasks.filter(task => task.status === 'inProgress');
                    break;
                case 'completed':
                    filteredTasks = tasks.filter(task => task.status === 'completed');
                    break;
                default:
                    filteredTasks = [...tasks];
            }

            // Sort tasks by deadline and priority
            filteredTasks.sort((a, b) => {
                // First by deadline
                const dateA = new Date(a.deadline);
                const dateB = new Date(b.deadline);
                if (dateA < dateB) return -1;
                if (dateA > dateB) return 1;

                // Then by priority
                const priorityValues = { high: 3, medium: 2, low: 1 };
                return priorityValues[b.priority] - priorityValues[a.priority];
            });

            // Clear task container
            taskContainer.innerHTML = '';

            // Show empty message if no tasks
            if (filteredTasks.length === 0) {
                taskContainer.appendChild(emptyMessage);
                return;
            }

            // Render each task
            filteredTasks.forEach(task => {
                const taskElement = createTaskElement(task);
                taskContainer.appendChild(taskElement);
            });

            // Update counters and progress
            updateCounters();
        }

        function createTaskElement(task) {
            const taskElement = document.createElement('div');
            taskElement.className = `task-container bg-white p-4 ${task.priority}-priority`;
            taskElement.dataset.id = task.id;

            // Calculate if task is overdue
            const now = new Date();
            const deadline = new Date(task.deadline);
            const isOverdue = deadline < now && task.status !== 'completed';

            // Format deadline
            const deadlineFormatted = formatDeadline(deadline, isOverdue);

            // Priority text
            const priorityText = {
                high: 'Ưu tiên cao',
                medium: 'Ưu tiên trung bình',
                low: 'Ưu tiên thấp'
            }[task.priority];

            // Status text and class
            const statusInfo = {
                notStarted: { text: 'Chưa làm', class: 'not-started-badge' },
                inProgress: { text: 'Đang làm', class: 'in-progress-badge' },
                completed: { text: 'Đã làm', class: 'completed-badge' }
            }[task.status];

            // Task HTML
            taskElement.innerHTML = `
                <div class="flex items-start">
                    <div class="custom-checkbox ${task.status === 'completed' ? 'checked' : ''}" data-id="${task.id}"></div>
                    <div class="ml-3 flex-grow">
                        <h3 class="font-medium text-gray-800 ${task.status === 'completed' ? 'line-through text-gray-500' : ''}">${task.title}</h3>
                        <div class="flex items-center text-sm text-gray-600 mt-1">
                            <i class="fas fa-book mr-1"></i> ${task.subject}
                        </div>
                        <div class="flex items-center text-sm ${isOverdue ? 'text-red-500' : 'text-gray-500'} mt-1">
                            <i class="far fa-clock mr-1"></i> ${deadlineFormatted}
                        </div>
                        <div class="flex flex-wrap gap-2 mt-2">
                            <span class="px-3 py-1 text-xs font-medium rounded-full ${task.priority === 'high' ? 'bg-red-100 text-red-700' : (task.priority === 'medium' ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700')}">${priorityText}</span>
                            <span class="px-3 py-1 text-xs font-medium rounded-full ${statusInfo.class}">${statusInfo.text}</span>
                        </div>
                    </div>
                    <div class="task-actions relative">
                        <button class="toggleDropdown p-2 hover:bg-gray-100 rounded-full" data-id="${task.id}">
                            <i class="fas fa-ellipsis-v text-gray-500"></i>
                        </button>
                        <div class="dropdown-menu hidden" id="dropdown-${task.id}">
                            ${task.status !== 'notStarted' ? `<div class="dropdown-item" data-action="changeStatus" data-status="notStarted" data-id="${task.id}"><i class="fas fa-circle text-gray-500 mr-2"></i> Chuyển sang Chưa làm</div>` : ''}
                            ${task.status !== 'inProgress' ? `<div class="dropdown-item" data-action="changeStatus" data-status="inProgress" data-id="${task.id}"><i class="fas fa-spinner text-blue-500 mr-2"></i> Chuyển sang Đang làm</div>` : ''}
                            ${task.status !== 'completed' ? `<div class="dropdown-item" data-action="changeStatus" data-status="completed" data-id="${task.id}"><i class="fas fa-check-circle text-green-500 mr-2"></i> Chuyển sang Đã làm</div>` : ''}
                            <div class="dropdown-item" data-action="edit" data-id="${task.id}"><i class="fas fa-edit text-yellow-500 mr-2"></i> Chỉnh sửa</div>
                            <div class="dropdown-item" data-action="delete" data-id="${task.id}"><i class="fas fa-trash text-red-500 mr-2"></i> Xóa</div>
                        </div>
                    </div>
                </div>
            `;

            // Add event listeners
            setTimeout(() => {
                // Checkbox click
                const checkbox = taskElement.querySelector('.custom-checkbox');
                checkbox.addEventListener('click', () => {
                    const newStatus = task.status === 'completed' ? (task.status === 'inProgress' ? 'inProgress' : 'notStarted') : 'completed';
                    changeTaskStatus(task.id, newStatus);
                });

                // Toggle dropdown
                const dropdownToggle = taskElement.querySelector('.toggleDropdown');
                dropdownToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const dropdownId = `dropdown-${task.id}`;
                    const dropdown = document.getElementById(dropdownId);

                    if (activeDropdown && activeDropdown !== dropdown) {
                        closeDropdown(activeDropdown);
                    }

                    if (dropdown.classList.contains('hidden')) {
                        openDropdown(dropdown);
                    } else {
                        closeDropdown(dropdown);
                    }
                });

                // Dropdown actions
                const dropdownItems = taskElement.querySelectorAll('.dropdown-item');
                dropdownItems.forEach(item => {
                    item.addEventListener('click', (e) => {
                        const action = item.dataset.action;
                        const id = item.dataset.id;

                        if (action === 'delete') {
                            deleteTask(id);
                        } else if (action === 'edit') {
                            editTask(id);
                        } else if (action === 'changeStatus') {
                            const status = item.dataset.status;
                            changeTaskStatus(id, status);
                        }

                        // Close dropdown
                        closeDropdown(document.getElementById(`dropdown-${id}`));
                    });
                });
            }, 0);

            return taskElement;
        }

        function openDropdown(dropdown) {
            dropdown.classList.remove('hidden');
            activeDropdown = dropdown;
        }

        function closeDropdown(dropdown) {
            if (dropdown) {
                dropdown.classList.add('hidden');
                activeDropdown = null;
            }
        }

        function switchTab(tabName) {
            // Update current tab
            currentTab = tabName;

            // Update active tab styling
            document.querySelectorAll('.tab').forEach(tab => {
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            // Render tasks for selected tab
            renderTasks();
        }

        function updateCounters() {
            // Update tab counters
            const notStartedCount = tasks.filter(task => task.status === 'notStarted').length;
            const inProgressCount = tasks.filter(task => task.status === 'inProgress').length;
            const completedTasksCount = tasks.filter(task => task.status === 'completed').length;

            allTabElement.textContent = `Tất cả (${tasks.length})`;
            notStartedTabElement.textContent = `Chưa làm (${notStartedCount})`;
            inProgressTabElement.textContent = `Đang làm (${inProgressCount})`;
            completedTabElement.textContent = `Đã làm (${completedTasksCount})`;

            // Update progress bar
            const progressValue = tasks.length > 0 ? Math.round((completedTasksCount / tasks.length) * 100) : 0;
            progressBar.style.width = `${progressValue}%`;
            progressPercentage.textContent = `${progressValue}%`;

            // Update completed and overdue counts
            completedCount.innerHTML = `<i class="fas fa-check-circle mr-1"></i> ${completedTasksCount} đã hoàn thành`;

            const now = new Date();
            const overdueTasksCount = tasks.filter(task => {
                return task.status !== 'completed' && new Date(task.deadline) < now;
            }).length;

            overdueCount.innerHTML = `<i class="fas fa-exclamation-circle mr-1"></i> ${overdueTasksCount} quá hạn`;
        }

        function openModal(modal) {
            modal.style.display = 'flex';
        }

        function closeAllModals() {
            addTaskModal.style.display = 'none';
            editTaskModal.style.display = 'none';
        }

        function resetAddTaskForm() {
            addTaskForm.reset();

            // Set default date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);

            const formattedDate = tomorrow.toISOString().split('T')[0];
            document.getElementById('taskDeadlineDate').value = formattedDate;

            // Set default time to 23:59
            document.getElementById('taskDeadlineTime').value = '23:59';
        }

        function updateSubjectList() {
            // Clear existing options
            subjectListElement.innerHTML = '';

            // Add options for each subject
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                subjectListElement.appendChild(option);
            });
        }

        // Notification Functions
        function showNotification(title, message, type = 'info') {
            const notificationTitle = notification.querySelector('.notification-title');
            const notificationBody = notification.querySelector('.notification-body');
            const notificationIcon = notification.querySelector('.notification-icon i');

            // Set content
            notificationTitle.textContent = title;
            notificationBody.textContent = message;

            // Set icon and style based on type
            notification.className = 'notification';

            switch (type) {
                case 'success':
                    notification.classList.add('notification-motivational');
                    notificationIcon.className = 'fas fa-check';
                    break;
                case 'warning':
                    notification.classList.add('notification-upcoming');
                    notificationIcon.className = 'fas fa-exclamation-triangle';
                    break;
                case 'error':
                    notification.classList.add('notification-overdue');
                    notificationIcon.className = 'fas fa-times-circle';
                    break;
                default:
                    notification.classList.add('notification-incomplete');
                    notificationIcon.className = 'fas fa-info-circle';
            }

            // Show notification
            notification.classList.add('show');

            // Thông báo hệ thống (nếu được cấp quyền)
            if (window.Notification && Notification.permission === "granted") {
                new Notification(title, { body: message });
            } else if (window.Notification && Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        new Notification(title, { body: message });
                    }
                });
            }
            // Hide after 3 seconds
            setTimeout(() => {
                hideNotification();
            }, 3000);
        }

        function showTaskNotification(title, message, type) {
            showNotification(title, message, type);
        }

        function hideNotification() {
            notification.classList.remove('show');
        }

        function showAlert(message) {
            alert(message);
        }

        // Notification system
        function startNotifications() {
            // Clear any existing interval
            if (notificationInterval) {
                clearInterval(notificationInterval);
            }

            // Start new interval (15 seconds)
            notificationInterval = setInterval(() => {
                showSmartNotification();
            }, 15000);

            // Show first notification after 2 seconds
            setTimeout(() => {
                showSmartNotification();
            }, 2000);
        }

        function showSmartNotification() {
            if (tasks.length === 0) {
                showNotification(
                    'Bắt đầu quản lý học tập',
                    'Hãy thêm nhiệm vụ học tập đầu tiên của bạn!',
                    'motivational'
                );
                notificationQueue = [];
                notificationQueueIndex = 0;
                return;
            }

            if (notificationQueue.length === 0) {
                resetNotificationQueue();
            }

            // Nếu index vượt quá queue thì reset về 0
            if (notificationQueueIndex >= notificationQueue.length) {
                notificationQueueIndex = 0;
            }

            // Lặp để bỏ qua các task đã completed
            let count = 0;
            let notified = false;
            while (notificationQueue.length > 0 && count < notificationQueue.length) {
                const next = notificationQueue[notificationQueueIndex];
                notificationQueueIndex = (notificationQueueIndex + 1) % notificationQueue.length;

                if (next.task && next.task.status === 'completed') {
                    count++;
                    continue;
                }

                if (next.type === 'overdue') {
                    const overdueTime = getOverdueDuration(new Date(next.task.deadline));
                    showTaskNotification(
                        'Nhiệm vụ quá hạn',
                        `Nhiệm vụ '${next.task.title}' môn ${next.task.subject} đã quá hạn ${overdueTime}. Hãy hoàn thành ngay!`,
                        'error'
                    );
                    notified = true;
                    return;
                } else if (next.type === 'upcoming') {
                    const remainingTime = getRemainingTime(new Date(next.task.deadline));
                    showTaskNotification(
                        'Nhiệm vụ sắp đến hạn',
                        `Nhiệm vụ '${next.task.title}' môn ${next.task.subject} sẽ đến hạn ${remainingTime}. Hãy chuẩn bị!`,
                        'warning'
                    );
                    notified = true;
                    return;
                } else if (next.type === 'incomplete') {
                    showTaskNotification(
                        'Nhiệm vụ chưa hoàn thành',
                        `Nhiệm vụ '${next.task.title}' môn ${next.task.subject} chưa hoàn thành. Hãy bắt đầu ngay!`,
                        'info'
                    );
                    notified = true;
                    return;
                } else {
                    // Motivational messages
                    const motivationalMessages = [
                        'Bạn đã hoàn thành ' + tasks.filter(t => t.status === 'completed').length + ' nhiệm vụ. Hãy tiếp tục phát huy!',
                        'Học tập đều đặn mỗi ngày sẽ giúp bạn tiến bộ nhanh hơn.',
                        'Mỗi nhiệm vụ hoàn thành là một bước tiến trong hành trình học tập của bạn.',
                        'Chỉ cần bắt đầu là bạn đã thành công một nửa. Hãy bắt đầu ngay hôm nay!',
                        'Học tập là quá trình, không phải đích đến. Hãy kiên nhẫn và kiên trì.',
                        'Đừng để việc học dồn vào phút cuối. Hãy lên kế hoạch từ sớm!',
                        'Công thức của thành công là 10% tài năng và 90% nỗ lực.',
                        'Một ngày không học tập là một ngày lãng phí. Hãy học điều gì đó mỗi ngày!',
                        'Thất bại là mẹ thành công. Đừng bỏ cuộc khi gặp khó khăn.',
                        'Kỷ luật là cầu nối giữa mục tiêu và thành tựu.'
                    ];
                    const randomMessage = motivationalMessages[Math.floor(Math.random() * motivationalMessages.length)];
                    showTaskNotification(
                        'Lời nhắc nhở',
                        randomMessage,
                        'success'
                    );
                    notified = true;
                    return;
                }
            }

            // Nếu không thông báo được task nào (toàn bộ queue đã completed hoặc không hợp lệ), reset lại queue và thử lại
            if (!notified) {
                resetNotificationQueue();
                // Nếu sau khi reset vẫn còn queue, thử lại 1 lần nữa
                if (notificationQueue.length > 0) {
                    showSmartNotification();
                }
            }
        }

        // Reset notification queue nhưng giữ vị trí hiện tại nếu có thể
        function resetNotificationQueue() {
            const now = new Date();
            const overdueTasks = tasks.filter(task =>
                task.status !== 'completed' && new Date(task.deadline) < now
            );
            const twoDaysFromNow = new Date(now);
            twoDaysFromNow.setDate(twoDaysFromNow.getDate() + 2);
            const upcomingTasks = tasks.filter(task => {
                const deadline = new Date(task.deadline);
                return task.status !== 'completed' && deadline > now && deadline <= twoDaysFromNow;
            });
            const overdueAndUpcomingIds = new Set([
                ...overdueTasks.map(t => t.id),
                ...upcomingTasks.map(t => t.id)
            ]);
            const incompleteTasks = tasks.filter(task =>
                (task.status === 'notStarted' || task.status === 'inProgress') && !overdueAndUpcomingIds.has(task.id)
            );

            // Lưu lại id task hiện tại nếu có
            let currentId = null;
            if (notificationQueue.length > 0 && notificationQueueIndex < notificationQueue.length) {
                const current = notificationQueue[notificationQueueIndex];
                if (current && current.task) currentId = current.task.id;
            }

            notificationQueue = [
                ...overdueTasks.map(task => ({ type: 'overdue', task })),
                ...upcomingTasks.map(task => ({ type: 'upcoming', task })),
                ...incompleteTasks.map(task => ({ type: 'incomplete', task })),
                { type: 'motivational', task: null }
            ];

            // Tìm lại vị trí cũ nếu còn, nếu không thì giữ nguyên index hoặc về 0
            if (currentId) {
                const idx = notificationQueue.findIndex(item => item.task && item.task.id === currentId);
                notificationQueueIndex = idx !== -1 ? idx : Math.min(notificationQueueIndex, notificationQueue.length - 1);
            } else {
                notificationQueueIndex = Math.min(notificationQueueIndex, notificationQueue.length - 1);
            }
        }

        // Helper Functions
        function formatDeadline(deadline, isOverdue) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            const deadlineDate = new Date(deadline.getFullYear(), deadline.getMonth(), deadline.getDate());

            let dateStr = '';
            if (deadlineDate.getTime() === today.getTime()) {
                dateStr = 'Hôm nay';
            } else if (deadlineDate.getTime() === tomorrow.getTime()) {
                dateStr = 'Ngày mai';
            } else {
                dateStr = deadline.toLocaleDateString('vi-VN');
            }

            const timeStr = deadline.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });

            if (isOverdue) {
                return `Quá hạn: ${dateStr}, ${timeStr}`;
            }

            return `Hạn: ${dateStr}, ${timeStr}`;
        }

        function getOverdueDuration(deadline) {
            const now = new Date();
            const diff = now - deadline;

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

            if (days > 0) {
                return `${days} ngày ${hours} giờ`;
            } else {
                return `${hours} giờ`;
            }
        }

        function getRemainingTime(deadline) {
            const now = new Date();
            const diff = deadline - now;

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

            if (days > 0) {
                return `trong ${days} ngày ${hours} giờ`;
            } else {
                return `trong ${hours} giờ`;
            }
        }

        function translateStatus(status) {
            switch (status) {
                case 'notStarted': return 'Chưa làm';
                case 'inProgress': return 'Đang làm';
                case 'completed': return 'Đã làm';
                default: return status;
            }
        }

        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function isDuplicateTask(title, subject, excludeId = null) {
            return tasks.some(task =>
                task.title.toLowerCase() === title.toLowerCase() &&
                task.subject.toLowerCase() === subject.toLowerCase() &&
                (excludeId === null || task.id !== excludeId)
            );
        }

        // Storage Functions
        function loadTasks() {
            const storedTasks = localStorage.getItem('tasks');
            tasks = storedTasks ? JSON.parse(storedTasks) : [];
        }

        function saveTasks() {
            localStorage.setItem('tasks', JSON.stringify(tasks));
        }

        function loadSubjects() {
            const storedSubjects = localStorage.getItem('subjects');
            subjects = storedSubjects ? JSON.parse(storedSubjects) : [];
        }

        function saveSubjects() {
            localStorage.setItem('subjects', JSON.stringify(subjects));
        }
    </script>
</body>

</html>